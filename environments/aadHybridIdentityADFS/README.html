
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AAD Hybrid Identity: AD FS Environment &#8212; SimuLand</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >let toggleHintShow = 'Click to show';</script>
    <script >let toggleHintHide = 'Click to hide';</script>
    <script >let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://simulandlabs.com/environments/aadHybridIdentityADFS/README.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="All Labs" href="../../labs/README.html" />
    <link rel="prev" title="Lab Environments" href="../README.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SimuLand</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Lab Environments
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../_helper-docs/README.html">
   Helper Docs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/addDomainToM365.html">
     Add Domain to Microsoft 365 Tenant
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/addM365LicenseToUser.html">
     Add Microsoft 365 E5 License to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/assignAADRole.html">
     Assign Azure AD Role to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/configureAADConnectADFS.html">
     Configure Azure AD Connect: ADFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/configureM365Defender.html">
     Initialize Microsoft 365 Defenders Security Products Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/connectAzVmAzBastion.html">
     Connect to Azure VM via Azure Bastion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/createPrivateContainerUploadFile.html">
     Create an Azure Storage Account and Host a Private File in a Private Container
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/disableAzureADFederation.html">
     Disable Azure Active Directory (AD) Federation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/enableMultiFactorAuthentication.html">
     Enable Multi-Factor Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/enableOffice365AuditLogSearch.html">
     Enable Office 365 Audit Log Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/getTrustedCASignedSSLCertificate.html">
     Create a Certificate Signing Request and Get a Trusted CA Signed SSL Certificate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/m365TenantGetAzSubscription.html">
     Microsoft 365 Tenant: Get an Azure Subscription
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/registerAADAppAndSP.html">
     Register Azure AD Application and Create App Service Principal
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../_helper-docs/startM365E5Trial.html">
     Start Microsoft 365 E5 Trial
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../README.html">
   Lab Environments
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     AAD Hybrid Identity: AD FS Environment
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lab Guides
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../labs/README.html">
   All Labs
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../labs/GoldenSAML/README.html">
   Golden SAML
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-configuration/README.html">
     Export AD FS Configuration
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-configuration/exportADFSConfigLocalNamedPipe.html">
       Export AD FS Configuration via a Local Named Pipe
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-configuration/exportADFSConfigWCFPolicyStore.html">
       Export AD FS Configuration via Policy Store Transfer Service
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-configuration/exportADFSConfigDotNETReflection.html">
       Export AD FS Configuration via .NET Reflection
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-dkm-key/README.html">
     Export AD FS DKM Master Key
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-dkm-key/exportADFSDKMKeyLDAP.html">
       Export AD FS DKM Master Key via LDAP Queries
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-dkm-key/exportADFSDKMKeyDRS.html">
       Export AD FS DKM Master Key via Directory Replication Services
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-certificates/README.html">
     Export AD FS Certificates
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../labs/GoldenSAML/simulation/export-adfs-certificates/exportADFSCertsDKMKey.html">
       Export AD FS Certificates via DKM Master Key
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/sign-new-samltoken/README.html">
     Forge SAML Tokens
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/get-oauth-accesstoken/README.html">
     Get OAuth Access Token with SAML Assertion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../labs/GoldenSAML/simulation/read-mail-messages/README.html">
     Read Mail Messages via MS Graph APIs
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/environments/aadHybridIdentityADFS/README.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Azure/SimuLand"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Azure/SimuLand/issues/new?title=Issue%20on%20page%20%2Fenvironments/aadHybridIdentityADFS/README.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#network-design">
   Network Design
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#domain-users-information">
     Domain Users Information
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#domain-endpoints-information">
     Domain Endpoints Information
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare">
   Prepare
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-lab-infrastructure">
   Deploy Lab Infrastructure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#elevate-account-access">
     Elevate account access
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-resource-group">
     Create Resource Group
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-arm-template">
     Deploy ARM Template
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#validate-deployment">
   Validate Deployment
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#on-prem-virtual-network-deployed">
     “On-Prem” Virtual Network Deployed
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validate-ad-fs-service-is-running">
     Validate AD FS Service is Running
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validate-ad-fs-service-via-the-intranet">
     Validate AD FS Service via the Intranet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-instance">
     Microsoft Sentinel Instance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-data-connectors">
     Microsoft Sentinel Data Connectors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-analytics-active-scheduled-alerts">
     Microsoft Sentinel Analytics – Active Scheduled Alerts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#azure-ad-active-directory-diagnostic-settings">
     Azure AD Active Directory - Diagnostic Settings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-analytics-workspace-windows-event-logs">
     Log Analytics Workspace – Windows Event Logs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-defender-for-endpoint">
     Microsoft Defender for Endpoint
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-defender-for-identity">
     Microsoft Defender for Identity
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#post-deployment-tasks">
   Post-Deployment Tasks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cleanup">
   Cleanup
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>AAD Hybrid Identity: AD FS Environment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#network-design">
   Network Design
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#domain-users-information">
     Domain Users Information
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#domain-endpoints-information">
     Domain Endpoints Information
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare">
   Prepare
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-lab-infrastructure">
   Deploy Lab Infrastructure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#elevate-account-access">
     Elevate account access
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-resource-group">
     Create Resource Group
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-arm-template">
     Deploy ARM Template
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#validate-deployment">
   Validate Deployment
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#on-prem-virtual-network-deployed">
     “On-Prem” Virtual Network Deployed
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validate-ad-fs-service-is-running">
     Validate AD FS Service is Running
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validate-ad-fs-service-via-the-intranet">
     Validate AD FS Service via the Intranet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-instance">
     Microsoft Sentinel Instance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-data-connectors">
     Microsoft Sentinel Data Connectors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-sentinel-analytics-active-scheduled-alerts">
     Microsoft Sentinel Analytics – Active Scheduled Alerts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#azure-ad-active-directory-diagnostic-settings">
     Azure AD Active Directory - Diagnostic Settings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-analytics-workspace-windows-event-logs">
     Log Analytics Workspace – Windows Event Logs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-defender-for-endpoint">
     Microsoft Defender for Endpoint
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microsoft-defender-for-identity">
     Microsoft Defender for Identity
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#post-deployment-tasks">
   Post-Deployment Tasks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cleanup">
   Cleanup
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="aad-hybrid-identity-ad-fs-environment">
<h1>AAD Hybrid Identity: AD FS Environment<a class="headerlink" href="#aad-hybrid-identity-ad-fs-environment" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FSimuLand%2Fmain%2Fdocs%2Fenvironments%2FaadHybridIdentityADFS%2Fazuredeploy.json"><img alt="Deploy to Azure" src="https://aka.ms/deploytoazurebutton" /></a>
<a class="reference external" href="https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FSimuLand%2Fmain%2Fdocs%2Fenvironments%2FaadHybridIdentityADFS%2Fazuredeploy.json"><img alt="Deploy to Azure Gov" src="https://aka.ms/deploytoazuregovbutton" /></a></p>
<p>This environment was designed to replicate an on-prem Active Directory (AD) network synced with Azure AD to authenticate to the cloud with the same identity used on-prem. The authentication method used in this environment is federation with Active Directory Services (AD FS).</p>
<div class="section" id="network-design">
<h2>Network Design<a class="headerlink" href="#network-design" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="../../_images/2021-05-19_01_network_design.png" /></p>
<div class="section" id="domain-users-information">
<h3>Domain Users Information<a class="headerlink" href="#domain-users-information" title="Permalink to this headline">¶</a></h3>
<p>You can change the default domain users through the <code class="docutils literal notranslate"><span class="pre">domainUsers</span></code> parameter in the main ARM template.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>FirstName</p></th>
<th class="text-align:left head"><p>LastName</p></th>
<th class="text-align:left head"><p>SamAccountName</p></th>
<th class="text-align:left head"><p>Department</p></th>
<th class="text-align:left head"><p>JobTitle</p></th>
<th class="text-align:left head"><p>Password</p></th>
<th class="text-align:left head"><p>Identity</p></th>
<th class="text-align:left head"><p>UserContainer</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Norah</p></td>
<td class="text-align:left"><p>Martha</p></td>
<td class="text-align:left"><p>nmartha</p></td>
<td class="text-align:left"><p>Human Resources</p></td>
<td class="text-align:left"><p>HR Director</p></td>
<td class="text-align:left"><p>S&#64;l&#64;m3!123</p></td>
<td class="text-align:left"><p>Users</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Pedro</p></td>
<td class="text-align:left"><p>Gustavo</p></td>
<td class="text-align:left"><p>pgustavo</p></td>
<td class="text-align:left"><p>IT Support</p></td>
<td class="text-align:left"><p>CIO</p></td>
<td class="text-align:left"><p>W1n1!2019</p></td>
<td class="text-align:left"><p>Domain Admins</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Clem</p></td>
<td class="text-align:left"><p>Jones</p></td>
<td class="text-align:left"><p>cjones</p></td>
<td class="text-align:left"><p>Research</p></td>
<td class="text-align:left"><p>Lead</p></td>
<td class="text-align:left"><p>Tr3&#64;sur3Hunt!</p></td>
<td class="text-align:left"><p>Domain Admins</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Lucho</p></td>
<td class="text-align:left"><p>Rodriguez</p></td>
<td class="text-align:left"><p>lrodriguez</p></td>
<td class="text-align:left"><p>Accounting</p></td>
<td class="text-align:left"><p>VP</p></td>
<td class="text-align:left"><p>T0d&#64;y!2019</p></td>
<td class="text-align:left"><p>Users</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Stevie</p></td>
<td class="text-align:left"><p>Beavers</p></td>
<td class="text-align:left"><p>sbeavers</p></td>
<td class="text-align:left"><p>Sales</p></td>
<td class="text-align:left"><p>Agent</p></td>
<td class="text-align:left"><p>B1gM&#64;c!2020</p></td>
<td class="text-align:left"><p>Users</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Sysmon</p></td>
<td class="text-align:left"><p>MS</p></td>
<td class="text-align:left"><p>sysmonsvc</p></td>
<td class="text-align:left"><p>IT Support</p></td>
<td class="text-align:left"><p>Service Account</p></td>
<td class="text-align:left"><p>Buggy!1122</p></td>
<td class="text-align:left"><p>Users</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Nxlog</p></td>
<td class="text-align:left"><p>Shipper</p></td>
<td class="text-align:left"><p>nxlogsvc</p></td>
<td class="text-align:left"><p>IT Support</p></td>
<td class="text-align:left"><p>Service Account</p></td>
<td class="text-align:left"><p>S3nData!1122</p></td>
<td class="text-align:left"><p>Users</p></td>
<td class="text-align:left"><p>DomainUsers</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="domain-endpoints-information">
<h3>Domain Endpoints Information<a class="headerlink" href="#domain-endpoints-information" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Device Name</p></th>
<th class="text-align:left head"><p>Platform</p></th>
<th class="text-align:left head"><p>IP Address</p></th>
<th class="text-align:left head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>DC01</p></td>
<td class="text-align:left"><p>Windows Server 2019</p></td>
<td class="text-align:left"><p>192.168.2.4</p></td>
<td class="text-align:left"><p>Active Directory Domain Services (AD DS) server</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>ADFS01</p></td>
<td class="text-align:left"><p>Windows Server 2019</p></td>
<td class="text-align:left"><p>192.168.2.5</p></td>
<td class="text-align:left"><p>Active Directory Federation Services (AD FS) server</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>WORKSTATION6</p></td>
<td class="text-align:left"><p>Windows 10</p></td>
<td class="text-align:left"><p>192.168.2.6</p></td>
<td class="text-align:left"><p>Domain-joined workstation</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="prepare">
<h2>Prepare<a class="headerlink" href="#prepare" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference internal" href="../_helper-docs/startM365E5Trial.html"><span class="doc std std-doc">Get a Microsoft 365 E5 license.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/m365TenantGetAzSubscription.html"><span class="doc std std-doc">Get an Azure subscription.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/addDomainToM365.html"><span class="doc std std-doc">Add a custom domain to your Microsoft 365 tenant.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/enableOffice365AuditLogSearch.html"><span class="doc std std-doc">Enable Office 365 Audit Log Search.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/configureM365Defender.html"><span class="doc std std-doc">Configure Microsoft 365 Defender Security Products.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/getTrustedCASignedSSLCertificate.html"><span class="doc std std-doc">Get a trusted CA signed SSL certificate.</span></a></p></li>
<li><p><a class="reference internal" href="../_helper-docs/createPrivateContainerUploadFile.html"><span class="doc std std-doc">Create Azure Storage private container.</span></a></p>
<ul class="simple">
<li><p>Upload SSL certificate.</p></li>
<li><p>Upload MDE onboarding package.</p></li>
<li><p>Upload MDI onboarding package.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Install Azure CLI locally</a></p></li>
</ol>
</div>
<div class="section" id="deploy-lab-infrastructure">
<h2>Deploy Lab Infrastructure<a class="headerlink" href="#deploy-lab-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>Once you finish all the steps from the <code class="docutils literal notranslate"><span class="pre">Prepare</span></code> section, you should be ready to deploy the lab infrastructure..</p>
<div class="section" id="elevate-account-access">
<h3>Elevate account access<a class="headerlink" href="#elevate-account-access" title="Permalink to this headline">¶</a></h3>
<p>The ARM template for this environment is of <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deploy-to-tenant?tabs=azure-cli">tenant scope</a>. Therefore, <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deploy-to-tenant?tabs=azure-cli#required-access">you will need to elevate access to manage all Azure resources and assign “owner” or “contributor” roles to the account running the ARM template</a>.</p>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a>.</p></li>
<li><p>Log in with a <code class="docutils literal notranslate"><span class="pre">Global</span> <span class="pre">Administrator</span></code> account.</p></li>
<li><p>Go to Azure Active Directory &gt; Manage &gt; Properties.</p></li>
<li><p>Under Access management for Azure resources, set the toggle to <code class="docutils literal notranslate"><span class="pre">Yes</span></code>.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_02_elevate_account.png" /></p>
<ol class="simple">
<li><p>Save your setting. <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">setting</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">global</span> <span class="pre">property</span> <span class="pre">and</span> <span class="pre">applies</span> <span class="pre">only</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">currently</span> <span class="pre">signed</span> <span class="pre">in</span> <span class="pre">user</span></code>. You can’t elevate access for all members of the Global Admin role.</p></li>
<li><p>Locally on your computer, open PowerShell.</p></li>
<li><p>With Azure CLI installed, run the following command to log on as the <code class="docutils literal notranslate"><span class="pre">Global</span> <span class="pre">Administrator</span></code> account you used in the previous steps and that you want to use to deploy the environment with.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">az</span> <span class="n">login</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Assign <code class="docutils literal notranslate"><span class="pre">Owner</span> <span class="pre">Role</span></code> for <code class="docutils literal notranslate"><span class="pre">Root</span> <span class="pre">Scope</span> <span class="pre">(&quot;/&quot;)</span></code> to your own account.</p></li>
<li><p>Log out and log back in after running the following command:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>az role assignment create --scope &#39;/&#39; --role &#39;Owner&#39; --assignee-object-id $(az ad signed-in-user show --query objectId) --assignee-principal-type User
</pre></div>
</div>
</div>
<div class="section" id="create-resource-group">
<h3>Create Resource Group<a class="headerlink" href="#create-resource-group" title="Permalink to this headline">¶</a></h3>
<p>You can use an existing <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span></code>. However, I recommend creating a new one to avoid any issues with existing resources in the resource group.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">az</span> <span class="n">group</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">azhybrid</span> <span class="o">-</span><span class="n">l</span> <span class="n">eastus</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-arm-template">
<h3>Deploy ARM Template<a class="headerlink" href="#deploy-arm-template" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Copy the multi-line command below to your favorite <code class="docutils literal notranslate"><span class="pre">text</span> <span class="pre">editor</span></code> and update the default values (If you are not using PowerShell to run the commands below, make sure you update the format and the <code class="docutils literal notranslate"><span class="pre">backquote</span> <span class="pre">character</span></code> at the end of each line to whatever you use to run multi-line commands in your terminal).</p></li>
<li><p>Make sure you run the updated commands in the same PowerShell session you used to elevate your account access.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>az deployment tenant create `
    --template-uri https://raw.githubusercontent.com/Azure/SimuLand/main/docs/environments/aadHybridIdentityADFS/azuredeploy.json `
    --location YOURLOCATION `
    --parameters `
    resourceGroup=&#39;RESOURCE GROUP NAME&#39; `
    subscriptionId=&#39;SUBSCRIPTION ID&#39; `
    adminUsername=&#39;NEW LOCAL ADMIN&#39; `
    adminPassword=&#39;NEW LOCAL ADMIN PASSWORD&#39; `
    adfsUsername=&#39;NEW AD FS USER ACCOUNT&#39; `
    adfsPassword=&#39;NEW AD FS USER PASSWORD&#39; `
    domainFQDN=&#39;DOMAIN.COM&#39; `
    pfxCertName=&#39;CERT-NAME.pfx&#39; `
    pfxCertPassword=&#39;CERT-PASSWORD&#39; `
    _pfxCertBlobSasUrl=&#39;&quot;https://STORAGE ACCOUNT.blob.core.windows.net/CONTAINER NAME/CERT.PFX?SAS-TOKEN&quot;&#39; `
    _mdePackageBlobSasUrl=&#39;&quot;https://STORAGE ACCOUNT.blob.core.windows.net/CONTAINER NAME/MDE-FILE.zip?SASTOKEN&quot;&#39; `
    _mdiPackageBlobSasUrl=&#39;&quot;https://STORAGE ACCOUNT.blob.core.windows.net/CONTAINER NAME/MDI-FILE.zip?SASTOKEN&quot;&#39; `
    _mdiAccessKey=&#39;xxxxxx&#39;
</pre></div>
</div>
<p><strong>Parameter Definitions</strong>:</p>
<ul class="simple">
<li><p>resourceGroup = Azure resource group to deploy resources to.</p></li>
<li><p>subscriptionId= Azure subscription ID to deploy resources to.</p></li>
<li><p>adminUsername = New local administrator account.</p></li>
<li><p>adminPassword = Password for new local administrator account.</p></li>
<li><p>adfsUsername = New AD FS service account.</p></li>
<li><p>adfsPassword = Password for new AD FS service account.</p></li>
<li><p>domainFQDN = The FQDN of the Active Directory domain to be created. Make sure it matches the verified domain you are using for the lab environment and SSL certificate.</p></li>
<li><p>pfxCertName = Name of the trusted CA signed SSL certificate hosted in the Azure storage account private container (Example: <code class="docutils literal notranslate"><span class="pre">ADFS.pfx</span></code>). Check the <a class="reference internal" href="../_helper-docs/getTrustedCASignedSSLCertificate.html"><span class="doc std std-doc">getTrustedCASignedSSLCertificate docs</span></a> for additional context.</p></li>
<li><p>PfxCertPassword = <a class="reference external" href="https://github.com/Azure/SimuLand/blob/main/1_prepare/getTrustedCASignedSSLCertificate.md#5-export-certificate-and-private-key-pfx-format">Password used to export</a> trusted CA signed SSl certificate.</p></li>
<li><p>_pfxCertBlobSasUrl = Blob SAS Url to access a trusted CA signed SSL certificate hosted in an Azure storage account private container.</p></li>
<li><p>_mdePackageBlobSasUrl = Blob SAS Url to access an Microsoft Defender for Endpoint (MDE) install package hosted in an Azure storage account private container. Keep the default name of the file <code class="docutils literal notranslate"><span class="pre">WindowsDefenderATPOnboardingPackage.zip</span></code>.</p></li>
<li><p>_mdiPackageBlobSasUrl = Blob SAS Url to access an Microsoft Defender for Identity (MDI) install package hosted in an Azure account storage private container. Keep the default name of the file <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">ATP</span> <span class="pre">Sensor</span> <span class="pre">Setup.zip</span></code>.</p></li>
<li><p>_mdiAccessKey = Microsoft Defender for Identity (MDI) Access Key used to install an MDI sensor. This value is in your MDI portal under the sensors section.</p></li>
</ul>
<p>You can track your deployment by going to resource groups &gt; <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span> <span class="pre">NAME</span></code> &gt; Deployments.</p>
<p><img alt="" src="../../_images/2021-05-19_03_track_deployment.png" /></p>
<p>After 30-35 mins, most of the <code class="docutils literal notranslate"><span class="pre">on-prem</span></code> infrastructure and Microsoft Sentinel would be deployed.</p>
<p><strong>Additional Notes</strong>: While waiting for the installation of Microsoft Defender for Endpoint sensors, an endpoint extension might return an exception. However, if after checking the logs inside of the VM, and the error id is 35, it will continue checking for onboarding status and eventually finish the installation.</p>
</div>
</div>
<div class="section" id="validate-deployment">
<h2>Validate Deployment<a class="headerlink" href="#validate-deployment" title="Permalink to this headline">¶</a></h2>
<p>Once everything is deployed, I highly recommend you check the status of a few services and resources that were deployed by the ARM template provided with this setup.</p>
<div class="section" id="on-prem-virtual-network-deployed">
<h3>“On-Prem” Virtual Network Deployed<a class="headerlink" href="#on-prem-virtual-network-deployed" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Go to Resource Groups &gt; <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span> <span class="pre">Name</span></code>.</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Virtual</span> <span class="pre">Network</span></code> resource &gt; Monitoring &gt; Diagram.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_04_vnet_network_diagram.png" /></p>
</div>
<div class="section" id="validate-ad-fs-service-is-running">
<h3>Validate AD FS Service is Running<a class="headerlink" href="#validate-ad-fs-service-is-running" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Go to Resource Groups &gt; <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span> <span class="pre">Name</span></code></p></li>
<li><p>Select the ADFS01 virtual machine resource and click on <code class="docutils literal notranslate"><span class="pre">Connect</span></code> &gt; Bastion (<a class="reference internal" href="../_helper-docs/connectAzVmAzBastion.html"><span class="doc std std-doc">More details</span></a>).</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_05_adfs_connect_bastion.png" /></p>
<ol class="simple">
<li><p>Enter Administrator credentials</p></li>
<li><p>Open PowerShell as Administrator and run the following command to know if the AD FS service is running.</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nb">Get-Service</span> <span class="n">ADFSSRV</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Then, run the following command to get information about the AD FS server setup. You will need the value of HostName for the next section <code class="docutils literal notranslate"><span class="pre">step</span> <span class="pre">5</span></code>.</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nb">Get-AdfsProperties</span>
<span class="nb">Get-AdfsProperties</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">HostName</span>
</pre></div>
</div>
</div>
<div class="section" id="validate-ad-fs-service-via-the-intranet">
<h3>Validate AD FS Service via the Intranet<a class="headerlink" href="#validate-ad-fs-service-via-the-intranet" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Go to Resource Groups &gt; <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span> <span class="pre">Name</span></code></p></li>
<li><p>Select the WORKSTATION6 virtual machine and click on <code class="docutils literal notranslate"><span class="pre">Connect</span></code> &gt; Bastion (<a class="reference internal" href="../_helper-docs/connectAzVmAzBastion.html"><span class="doc std std-doc">More details</span></a>).</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_06_workstation6_connect_bastion.png" /></p>
<ol class="simple">
<li><p>Enter domain user credentials</p></li>
<li><p>Browse to <code class="docutils literal notranslate"><span class="pre">https://&lt;AD</span> <span class="pre">FS</span> <span class="pre">HostName&gt;/adfs/ls/idpinitiatedsignon.aspx</span></code></p></li>
</ol>
<ul class="simple">
<li><p>The AD FS HostName is what we got previously on <code class="docutils literal notranslate"><span class="pre">step</span> <span class="pre">6</span></code> in the previous section.</p></li>
<li><p>If you get a login page like the one below and you can authenticate with a domain user’s credentials, then the AD FS service is running properly via the Intranet.</p></li>
<li><p>You still need to link this service with Azure AD. More information about that is provided later in the <code class="docutils literal notranslate"><span class="pre">post-deployment</span> <span class="pre">tasks</span></code> section.</p></li>
</ul>
<p><img alt="" src="../../_images/2021-05-19_07_adfs_validate_intranet.png" /></p>
</div>
<div class="section" id="microsoft-sentinel-instance">
<h3>Microsoft Sentinel Instance<a class="headerlink" href="#microsoft-sentinel-instance" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Search for “Microsoft Sentinel”</p></li>
<li><p>Select Microsoft Sentinel instance created after running the ARM template.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_08_azure_sentinel_deployed.png" /></p>
</div>
<div class="section" id="microsoft-sentinel-data-connectors">
<h3>Microsoft Sentinel Data Connectors<a class="headerlink" href="#microsoft-sentinel-data-connectors" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Microsoft Sentinel Instance &gt; Data Connectors</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_09_azure_sentinel_dataconnectors.png" /></p>
</div>
<div class="section" id="microsoft-sentinel-analytics-active-scheduled-alerts">
<h3>Microsoft Sentinel Analytics – Active Scheduled Alerts<a class="headerlink" href="#microsoft-sentinel-analytics-active-scheduled-alerts" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Microsoft Sentinel Instance &gt; Analytics</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_10_azure_sentinel_analytics.png" /></p>
</div>
<div class="section" id="azure-ad-active-directory-diagnostic-settings">
<h3>Azure AD Active Directory - Diagnostic Settings<a class="headerlink" href="#azure-ad-active-directory-diagnostic-settings" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Search for <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code></p></li>
<li><p>Monitoring &gt; Diagnostic settings &gt; AADConnector-<code class="docutils literal notranslate"><span class="pre">Name</span></code> &gt; Edit Setting.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_11_aad_diagnostic_settings.png" /></p>
</div>
<div class="section" id="log-analytics-workspace-windows-event-logs">
<h3>Log Analytics Workspace – Windows Event Logs<a class="headerlink" href="#log-analytics-workspace-windows-event-logs" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://portal.azure.com/">Azure portal</a></p></li>
<li><p>Go to Resource Groups &gt; <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Group</span> <span class="pre">Name</span></code>.</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Log</span> <span class="pre">Analytics</span> <span class="pre">Workspace</span></code> resource.</p></li>
<li><p>Go to Settings &gt; Agents configuration &gt; Windows event logs.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_12_la_workspace_windows_event_logs.png" /></p>
</div>
<div class="section" id="microsoft-defender-for-endpoint">
<h3>Microsoft Defender for Endpoint<a class="headerlink" href="#microsoft-defender-for-endpoint" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://security.microsoft.com/">Microsoft 365 Security portal</a></p></li>
<li><p>Click on “More Resources”</p></li>
<li><p>Click on “Open” under the Microsoft Defender Security Center</p></li>
<li><p>Device Inventory</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_13_m365_defender_endpoint.png" /></p>
</div>
<div class="section" id="microsoft-defender-for-identity">
<h3>Microsoft Defender for Identity<a class="headerlink" href="#microsoft-defender-for-identity" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Browse to <a class="reference external" href="https://security.microsoft.com/">Microsoft 365 Security portal</a></p></li>
<li><p>Click on “More Resources”</p></li>
<li><p>Click on “Open” under Azure Advanced Threat Protection (Microsoft Defender for Identity)</p></li>
<li><p>Go to Configuration &gt; Sensors.
If you have a sensor that does not start properly or it is constantly stopping and restarting itself, check if the <code class="docutils literal notranslate"><span class="pre">Domain</span> <span class="pre">Controllers</span></code> value is set. I have seen AD FS servers not picking up the domain controller name. Simply click on the sensor name and add the FQDN of the domain controller to the <code class="docutils literal notranslate"><span class="pre">Domain</span> <span class="pre">Controllers</span></code> property of the sensor.</p></li>
</ol>
<p><img alt="" src="../../_images/2021-05-19_15_m365_defender_identity.png" /></p>
</div>
</div>
<div class="section" id="post-deployment-tasks">
<h2>Post-Deployment Tasks<a class="headerlink" href="#post-deployment-tasks" title="Permalink to this headline">¶</a></h2>
<p>Not everything can be automated yet. Therefore, there are a few additional tasks to complete:</p>
<ol class="simple">
<li><p><a class="reference internal" href="../_helper-docs/configureAADConnectADFS.html"><span class="doc std std-doc">Finish Azure AD Connect setup on the “on-prem” AD domain controller</span></a>.</p></li>
<li><p><a class="reference internal" href="../_helper-docs/enableMultiFactorAuthentication.html"><span class="doc std std-doc">Enable Multi-Factor authentication to domain users</span></a>.</p></li>
<li><p><a class="reference internal" href="../_helper-docs/assignAADRole.html"><span class="doc std std-doc">Assign “Application Administrator” role to one domain user</span></a>.</p></li>
<li><p><a class="reference internal" href="../_helper-docs/addM365LicenseToUser.html"><span class="doc std std-doc">Add Microsoft 365 E5 license to domain users</span></a>.</p></li>
<li><p><a class="reference internal" href="../_helper-docs/registerAADAppAndSP.html"><span class="doc std std-doc">Register an Azure AD Application</span></a>.</p></li>
</ol>
</div>
<div class="section" id="cleanup">
<h2>Cleanup<a class="headerlink" href="#cleanup" title="Permalink to this headline">¶</a></h2>
<p>If you want to remove some of the configurations, take a look at some of the documents below:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../_helper-docs/disableAzureADFederation.html"><span class="doc std std-doc">Disable Azure AD Federation</span></a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./environments\aadHybridIdentityADFS"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../README.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lab Environments</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../labs/README.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">All Labs</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Microsoft Corporation<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>