
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Get OAuth Access Token with SAML Assertion &#8212; SimuLand</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://simulandlabs.com/labs/GoldenSAML/simulation/get-oauth-accesstoken/README.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Read Mail Messages via MS Graph APIs" href="../read-mail-messages/README.html" />
    <link rel="prev" title="Forge SAML Tokens" href="../sign-new-samltoken/README.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SimuLand</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Lab Environments
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/_helper-docs/README.html">
   Helper Docs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addDomainToM365.html">
     Add Domain to Microsoft 365 Tenant
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addM365LicenseToUser.html">
     Add Microsoft 365 E5 License to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/assignAADRole.html">
     Assign Azure AD Role to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureAADConnectADFS.html">
     Configure Azure AD Connect: ADFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureAADConnectPTA.html">
     Configure Azure AD Connect: Pass-through Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureM365Defender.html">
     Initialize Microsoft 365 Defenders Security Products Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/connectAzVmAzBastion.html">
     Connect to Azure VM via Azure Bastion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/createPrivateContainerUploadFile.html">
     Create an Azure Storage Account and Host a Private File in a Private Container
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/disableAzureADFederation.html">
     Disable Azure Active Directory (AD) Federation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableMultiFactorAuthentication.html">
     Enable Multi-Factor Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableOffice365AuditLogSearch.html">
     Enable Office 365 Audit Log Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/getTrustedCASignedSSLCertificate.html">
     Create a Certificate Signing Request and Get a Trusted CA Signed SSL Certificate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/m365TenantGetAzSubscription.html">
     Microsoft 365 Tenant: Get an Azure Subscription
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/registerAADAppAndSP.html">
     Register Azure AD Application and Create App Service Principal
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/startM365E5Trial.html">
     Start Microsoft 365 E5 Trial
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/README.html">
   Lab Environments
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/aadHybridIdentityADFS/README.html">
     AAD Hybrid Identity: AD FS Environment
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Lab Guides
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../README.html">
   All Labs
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../README.html">
   Golden SAML
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-configuration/README.html">
     Export AD FS Configuration
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigLocalNamedPipe.html">
       Export AD FS Configuration via a Local Named Pipe
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigWCFPolicyStore.html">
       Export AD FS Configuration via Policy Store Transfer Service
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigDotNETReflection.html">
       Export AD FS Configuration via .NET Reflection
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-dkm-key/README.html">
     Export AD FS DKM Master Key
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-dkm-key/exportADFSDKMKeyLDAP.html">
       Export AD FS DKM Master Key via LDAP Queries
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-dkm-key/exportADFSDKMKeyDRS.html">
       Export AD FS DKM Master Key via Directory Replication Services
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-certificates/README.html">
     Export AD FS Certificates
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-certificates/exportADFSCertsDKMKey.html">
       Export AD FS Certificates via DKM Master Key
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../sign-new-samltoken/README.html">
     Forge SAML Tokens
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Get OAuth Access Token with SAML Assertion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../read-mail-messages/README.html">
     Read Mail Messages via MS Graph APIs
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/Azure/SimuLand/main?urlpath=tree/docs/labs/GoldenSAML/simulation/get-oauth-accesstoken/README.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/Azure/SimuLand"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/Azure/SimuLand/issues/new?title=Issue%20on%20page%20%2Flabs/GoldenSAML/simulation/get-oauth-accesstoken/README.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../../_sources/labs/GoldenSAML/simulation/get-oauth-accesstoken/README.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../../../../_sources/labs/GoldenSAML/simulation/get-oauth-accesstoken/README.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#encode-saml-token">
     Encode SAML token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-oauth-http-post-request">
     Create OAuth HTTP POST request
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#http-header">
       HTTP header
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#http-body">
       HTTP body
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#send-http-post-request-to-the-microsoft-identity-platform-token-endpoint">
     Send HTTP POST request to the Microsoft identity platform token endpoint
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-oauth-access-token-from-results">
     Get OAuth Access Token from Results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Get OAuth Access Token with SAML Assertion</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#encode-saml-token">
     Encode SAML token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-oauth-http-post-request">
     Create OAuth HTTP POST request
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#http-header">
       HTTP header
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#http-body">
       HTTP body
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#send-http-post-request-to-the-microsoft-identity-platform-token-endpoint">
     Send HTTP POST request to the Microsoft identity platform token endpoint
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-oauth-access-token-from-results">
     Get OAuth Access Token from Results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="get-oauth-access-token-with-saml-assertion">
<h1>Get OAuth Access Token with SAML Assertion<a class="headerlink" href="#get-oauth-access-token-with-saml-assertion" title="Permalink to this headline">#</a></h1>
<p>An access token is a security token that is issued by an <a class="reference external" href="https://docs.microsoft.com/en-gb/azure/active-directory/develop/developer-glossary#authorization-server">authorization server</a> as part of an OAuth 2.0 flow. Access tokens contain information about the client, who requests the token, and the OAuth protected resource (the API) the token is intended for (its audience).</p>
<p>The Microsoft identity platform (Azure AD) supports the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-saml-bearer-assertion">OAuth 2.0 SAML bearer assertion flow</a> which allows a user to use an existing trust relationship and request an OAuth access token using a SAML assertion. The SAML assertion is posted to the OAuth token endpoint. The endpoint processes the assertion and issues an access token based on prior approval of the OAuth protected application.</p>
<p>The client isn’t required to have or store a refresh token, nor is the client secret required to be passed to the token endpoint.</p>
<p>This type of flow supports users authenticating with identity providers such as <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Federation</span> <span class="pre">Services</span> <span class="pre">(ADFS)</span></code> to Azure Active Directory. The SAML assertion obtained from ADFS can be used in an OAuth flow to authenticate the user.</p>
<p>In this document, we are going to use an existing SAML token to exchange it for an OAuth access token from Azure active directory (Azure AD).</p>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#preconditions">Preconditions</a></p></li>
<li><p><a class="reference external" href="#simulation-steps">Simulation Steps</a></p></li>
<li><p><a class="reference external" href="#output">Output</a></p></li>
<li><p><a class="reference external" href="#references">References</a></p></li>
</ul>
</div>
<div class="section" id="preconditions">
<h2>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Input:</p>
<ul>
<li><p>SAML Token</p></li>
<li><p>Azure AD Application ID: The ID of the application (<code class="docutils literal notranslate"><span class="pre">appId</span></code>) to request the OAuth token (e.g Public Azure AD Application = <code class="docutils literal notranslate"><span class="pre">1b730954-1685-4b74-9bfd-dac224a7b894</span></code>).</p></li>
<li><p>Scope: A space-separated list of scopes, or permissions, that the app requires (e.g. Microsoft Graph = <code class="docutils literal notranslate"><span class="pre">&quot;https://graph.microsoft.com/.default</span></code>).</p></li>
<li><p>Client secret (optional):</p>
<ul>
<li><p>If your app is a public client, then <code class="docutils literal notranslate"><span class="pre">the</span> <span class="pre">client_secret</span></code> cannot be included. If the app is a confidential client (Your own app), then it must be included in the OAuth HTTP request.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="simulation-steps">
<h2>Simulation Steps<a class="headerlink" href="#simulation-steps" title="Permalink to this headline">#</a></h2>
<div class="section" id="encode-saml-token">
<h3>Encode SAML token<a class="headerlink" href="#encode-saml-token" title="Permalink to this headline">#</a></h3>
<ol class="simple">
<li><p>Open a PowerShell console and run the following command to base64 encode a SAML token to later use it in an OAuth HTTP request:</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$encodedSamlToken</span> <span class="p">=</span> <span class="no">[Convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$SamlToken</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_01_saml_token.png" /></p>
<p><img alt="" src="../../../../_images/2021-05-19_02_token_encoded.png" /></p>
</div>
<div class="section" id="create-oauth-http-post-request">
<h3>Create OAuth HTTP POST request<a class="headerlink" href="#create-oauth-http-post-request" title="Permalink to this headline">#</a></h3>
<div class="section" id="http-header">
<h4>HTTP header<a class="headerlink" href="#http-header" title="Permalink to this headline">#</a></h4>
<p>You can, for example, set the user Agent to look like <code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Outlook</span></code> or other known applications.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$headers</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s2">&quot;Content-Type&quot;</span> <span class="p">=</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span>
    <span class="s2">&quot;User-Agent&quot;</span> <span class="p">=</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; Tablet PC 2.0; Microsoft Outlook 16.0.4266)&quot;</span>
<span class="p">}</span>
<span class="nv">$headers</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_03_http_header.png" /></p>
</div>
<div class="section" id="http-body">
<h4>HTTP body<a class="headerlink" href="#http-body" title="Permalink to this headline">#</a></h4>
<p>Use the following parameters:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Required/Optional</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>client_id</p></td>
<td><p>required</p></td>
<td><p>ID of application to request OAuth access token</p></td>
</tr>
<tr class="row-odd"><td><p>grant_type</p></td>
<td><p>required</p></td>
<td><p>Must be <code class="docutils literal notranslate"><span class="pre">urn:ietf:params:oauth:grant-type:saml1_1-bearer</span></code></p></td>
</tr>
<tr class="row-even"><td><p>assertion</p></td>
<td><p>required</p></td>
<td><p>The base64 encoded SAML token</p></td>
</tr>
<tr class="row-odd"><td><p>scope</p></td>
<td><p>required</p></td>
<td><p>A space-separated list of scopes, or permissions, that the app requires</p></td>
</tr>
<tr class="row-even"><td><p>client_secret</p></td>
<td><p>optional</p></td>
<td><p>If your app is a public client (Azure AD PowerShell Application), then <code class="docutils literal notranslate"><span class="pre">the</span> <span class="pre">client_secret</span></code> cannot be included. If the app is a confidential client (Your own Azure AD application), then it must be included.</p></td>
</tr>
</tbody>
</table>
<p><strong>Scope</strong></p>
<p>For this example, we can use the Microsoft Graph API in the scope. Feel free to change this value depending on the use case.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$scope</span> <span class="p">=</span> <span class="s2">&quot;https://graph.microsoft.com/.default&quot;</span>
</pre></div>
</div>
<p><strong>Client ID</strong></p>
<p>We can request an OAuth access token leveraging the <code class="docutils literal notranslate"><span class="pre">public</span></code> Azure Active Directory PowerShell application (Cliend ID = <code class="docutils literal notranslate"><span class="pre">1b730954-1685-4b74-9bfd-dac224a7b894</span></code>).</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$ClientID</span> <span class="p">=</span> <span class="s2">&quot;1b730954-1685-4b74-9bfd-dac224a7b894&quot;</span>
</pre></div>
</div>
<p>If you want to use an application that you registered yourself, set the variable <code class="docutils literal notranslate"><span class="pre">$ClientID</span></code> to the ID of your application. Remember that you <code class="docutils literal notranslate"><span class="pre">must</span></code> use the application secret parameter in the <code class="docutils literal notranslate"><span class="pre">HTTP</span> <span class="pre">body</span></code> too when you use a confidential application.</p>
<p><strong>Body</strong></p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$body</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s2">&quot;client_id&quot;</span><span class="p">=</span><span class="nv">$ClientId</span>
    <span class="s2">&quot;grant_type&quot;</span><span class="p">=</span><span class="s2">&quot;urn:ietf:params:oauth:grant-type:saml1_1-bearer&quot;</span>
    <span class="s2">&quot;assertion&quot;</span><span class="p">=</span><span class="nv">$encodedSamlToken</span>
    <span class="s2">&quot;scope&quot;</span><span class="p">=</span><span class="nv">$scope</span>
<span class="p">}</span>
<span class="nv">$body</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_04_http_body_public_client.png" /></p>
<p>if you are using a client secret, then add it to the <code class="docutils literal notranslate"><span class="pre">$body</span></code> variable with the following commands:</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$secret</span> <span class="p">=</span> <span class="s1">&#39;xxxxxx&#39;</span>
<span class="nv">$body</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$secret</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="send-http-post-request-to-the-microsoft-identity-platform-token-endpoint">
<h3>Send HTTP POST request to the Microsoft identity platform token endpoint<a class="headerlink" href="#send-http-post-request-to-the-microsoft-identity-platform-token-endpoint" title="Permalink to this headline">#</a></h3>
<p>Send the OAuth token request to the OAuth 2.0 (v2) token endpoint: <code class="docutils literal notranslate"><span class="pre">https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token</span></code></p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$TenantId</span> <span class="p">=</span> <span class="s1">&#39;YOUR-TENANT-ID&#39;</span>
<span class="nv">$TokenUrl</span> <span class="p">=</span> <span class="s2">&quot;https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token&quot;</span>
<span class="nv">$params</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s2">&quot;Method&quot;</span><span class="p">=</span><span class="s2">&quot;Post&quot;</span>
    <span class="s2">&quot;Uri&quot;</span><span class="p">=</span><span class="nv">$TokenUrl</span>
    <span class="s2">&quot;Body&quot;</span><span class="p">=</span><span class="nv">$body</span>
    <span class="s2">&quot;Headers&quot;</span><span class="p">=</span><span class="nv">$headers</span>
<span class="p">}</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Invoke-RestMethod</span> <span class="nv">@params</span><span class="p">)</span>
<span class="nv">$results</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_07_send_oauth_http_request.png" /></p>
</div>
<div class="section" id="get-oauth-access-token-from-results">
<h3>Get OAuth Access Token from Results<a class="headerlink" href="#get-oauth-access-token-from-results" title="Permalink to this headline">#</a></h3>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$OAuthAccessToken</span> <span class="p">=</span> <span class="nv">$results</span><span class="p">.</span><span class="n">access_token</span>
<span class="nv">$OAuthAccessToken</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_09_mgraph_token.png" /></p>
<p>You can inspect your token here: <a class="reference external" href="https://jwt.ms/">jwt.ms: Welcome!</a></p>
</div>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>OAuth Access Token</p>
<ul>
<li><p>Use the variable <code class="docutils literal notranslate"><span class="pre">$OAuthAccessToken</span></code> to call the API defined in the <code class="docutils literal notranslate"><span class="pre">scope</span></code> parameter of the HTTP body.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://o365blog.com/post/adfs/">Exporting ADFS certificates revisited: Tactics, Techniques and Procedures (o365blog.com)</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./labs\GoldenSAML\simulation\get-oauth-accesstoken"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../sign-new-samltoken/README.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Forge SAML Tokens</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../read-mail-messages/README.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Read Mail Messages via MS Graph APIs</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Microsoft Corporation<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>